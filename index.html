<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Finanzas Personales</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK (COMPAT) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f2f4f7;
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
  margin-bottom:15px;
}
h2,h3{
  text-align:center;
  margin:10px 0;
}
.input-group{
  display:flex;
  margin-bottom:12px;
}
.input-group span{
  background:#e5e7eb;
  padding:10px 14px;
  border-radius:8px 0 0 8px;
  font-weight:bold;
}
.input-group input{
  flex:1;
  padding:10px;
  border:1px solid #ccc;
  border-left:none;
  border-radius:0 8px 8px 0;
  font-size:16px;
}
input, select, button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
.buttons{
  display:flex;
  gap:10px;
}
.ingreso{background:#16a34a;color:#fff;border:none;}
.egreso{background:#dc2626;color:#fff;border:none;}
.save{background:#2563eb;color:#fff;border:none;}
.logout{background:#6b7280;color:#fff;border:none;}
.summary{
  display:flex;
  justify-content:space-between;
  font-weight:bold;
  margin-top:5px;
}
.list{
  font-size:14px;
  margin-top:10px;
}
.list div{
  border-bottom:1px solid #eee;
  padding:6px 0;
}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2> Iniciar sesi贸n</h2>
  <button onclick="login()">Ingresar con Google</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<div class="card">
<h2> Nuevo Movimiento</h2>

<div class="input-group">
  <span>$</span>
  <input type="text" id="monto" inputmode="numeric" placeholder="0">
</div>

<input type="date" id="fecha">

<div class="buttons">
  <button class="ingreso" onclick="setTipo('INGRESO')">INGRESO</button>
  <button class="egreso" onclick="setTipo('EGRESO')">EGRESO</button>
</div>

<select id="categoria" style="display:none"></select>

<button class="save" onclick="guardar()">Guardar</button>
<button class="logout" onclick="logout()">Cerrar sesi贸n</button>
</div>

<div class="card">
<h3> Resumen</h3>

<select id="mesFiltro" onchange="cargar()"></select>
<select id="anioFiltro" onchange="cargar()"></select>

<div class="summary">
  <div>Ingresos:</div>
  <div id="totalIngresos">$0</div>
</div>
<div class="summary">
  <div>Egresos:</div>
  <div id="totalEgresos">$0</div>
</div>
<div class="summary">
  <div>Disponible:</div>
  <div id="disponible">$0</div>
</div>

<div class="list" id="lista"></div>
</div>

</div>
</div>

<script>
/*  CONFIGURACIN FIREBASE (TUYA) */
const firebaseConfig = {
  apiKey: "AIzaSyD0Lj9IrWH8deYcd0fsAzmFrDNPJaU34_c",
  authDomain: "lifance-d2316.firebaseapp.com",
  projectId: "lifance-d2316",
  storageBucket: "lifance-d2316.firebasestorage.app",
  messagingSenderId: "87725148350",
  appId: "1:87725148350:web:9d04cf1c247d9058eeb6ef"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let user = null;
let tipo = "";

/* AUTH */
auth.onAuthStateChanged(u=>{
  if(u){
    user = u;
    loginCard.style.display = "none";
    app.style.display = "block";
    fecha.valueAsDate = new Date();
    cargarFiltros();
    cargar();
  }else{
    loginCard.style.display = "block";
    app.style.display = "none";
  }
});

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout(){
  auth.signOut();
}

/* FORMATO MILES */
monto.addEventListener("input", ()=>{
  let v = monto.value.replace(/\D/g,"");
  monto.value = new Intl.NumberFormat("es-CO").format(v);
});

/* TIPO */
function setTipo(t){
  tipo = t;
  categoria.style.display = "block";

  if(t === "INGRESO"){
    categoria.innerHTML = `
      <option value="">Tipo ingreso</option>
      <option>N贸mina</option>
      <option>Carreras</option>
      <option>Pr茅stamos</option>
      <option>Otros Ingresos</option>
    `;
  }else{
    categoria.innerHTML = `
      <option value="">Tipo egreso</option>
      <option>Combustible</option>
      <option>Comisi贸n / Peajes</option>
      <option>Lavada</option>
      <option>Mantenimiento</option>
      <option>Hogar</option>
      <option>Salidas y Compras</option>
      <option>Gastos Menores</option>
      <option>Deudas</option>
      <option>Inversiones / Ahorros</option>
      <option>Pr茅stamos / Ajustes / GMF</option>
    `;
  }
}

/* GUARDAR */
function guardar(){
  if(!tipo || !categoria.value || !monto.value){
    alert("Completa todos los campos");
    return;
  }

  db.collection("movimientos").add({
    uid: user.uid,
    tipo: tipo,
    categoria: categoria.value,
    monto: Number(monto.value.replace(/\D/g,"")),
    fecha: fecha.value,
    creado: new Date()
  }).then(()=>{
    monto.value="";
    cargar();
  });
}

/* FILTROS */
function cargarFiltros(){
  mesFiltro.innerHTML = "<option value=''>Todos los meses</option>";
  for(let i=1;i<=12;i++){
    mesFiltro.innerHTML += `<option value="${i}">${i}</option>`;
  }

  const y = new Date().getFullYear();
  anioFiltro.innerHTML = "";
  for(let i=y;i>=y-5;i--){
    anioFiltro.innerHTML += `<option value="${i}">${i}</option>`;
  }
}

/* CARGAR DATOS */
function cargar(){
  lista.innerHTML = "";
  let ing = 0, egr = 0;

  db.collection("movimientos")
    .where("uid","==",user.uid)
    .get()
    .then(snap=>{
      snap.forEach(doc=>{
        const r = doc.data();
        const f = new Date(r.fecha);

        if(
          (!mesFiltro.value || f.getMonth()+1 == mesFiltro.value) &&
          (!anioFiltro.value || f.getFullYear() == anioFiltro.value)
        ){
          lista.innerHTML += `
            <div>
              ${r.fecha} | ${r.tipo} | ${r.categoria} | $${r.monto.toLocaleString("es-CO")}
            </div>
          `;
          r.tipo==="INGRESO" ? ing+=r.monto : egr+=r.monto;
        }
      });

      totalIngresos.textContent = "$" + ing.toLocaleString("es-CO");
      totalEgresos.textContent = "$" + egr.toLocaleString("es-CO");
      disponible.textContent = "$" + (ing - egr).toLocaleString("es-CO");
    });
}
</script>
</body>
</html>


